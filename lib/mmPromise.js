define(["avalon"],function(n){function t(n){return n}function e(n){throw n}function i(n){return this.then(n,e)}function o(n){return this.then(t,n)}function r(){var n={};return n.promise=new this(function(t,e){n.resolve=t,n.reject=e}),n}function f(n,t){if("boolean"==typeof n.async)var e=n.async;else e=n.async=!0;e?window.setTimeout(t,0):t()}function c(n,t){if("pending"===n._state)if(t&&"function"==typeof t.then){var e=t instanceof h?"_then":"then";t[e](function(t){a(n,t,!0)},function(t){a(n,t,!1)})}else a(n,t,!0)}function u(n,t){"pending"===n._state&&a(n,t,!1)}function a(n,t,e){n._fired=!0,n._value=t,n._state=e?"fulfilled":"rejected",f(n,function(){n._callbacks.forEach(function(t){n._fire(t.onSuccess,t.onFail)})})}function s(n,t){t=Array.isArray(t)?t:[];var e,i=0,o=[];return new h(function(r,f){function c(c,u){c.then(function(f){e||(o[u]=f,i++,(n||i>=t.length)&&(r(n?f:o),e=!0))},function(n){e=!0,f(n)})}t.length||r();for(var u=0,a=t.length;a>u;u++)c(t[u],u)})}var h=function(n){this._callbacks=[];var t=this;if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof n)throw new TypeError("not a function");n(function(n){c(t,n)},function(n){u(t,n)})};h.resolve=function(n){return new h(function(t){t(n)})},h.reject=function(n){return new h(function(t,e){e(n)})},h.prototype={constructor:h,_state:"pending",_fired:!1,_fire:function(n,t){if("rejected"===this._state){if("function"!=typeof t)throw this._value;t(this._value)}else"function"==typeof n&&n(this._value)},_then:function(n,t){if(this._fired){var e=this;f(e,function(){e._fire(n,t)})}else this._callbacks.push({onSuccess:n,onFail:t})},then:function(n,i){n="function"==typeof n?n:t,i="function"==typeof i?i:e;var o=this,r=new h(function(t,e){o._then(function(i){try{i=n(i)}catch(o){return void e(o)}t(i)},function(n){try{n=i(n)}catch(o){return void e(o)}t(n)})});for(var f in o)l[f]||(r[f]=o[f]);return r},done:i,"catch":o,fail:o};var l={_state:1,_fired:1,_value:1,_callbacks:1};h.all=function(n){return s(!1,n)},h.race=function(n){return s(!0,n)},h.defer=r,n.Promise=h;var _=window.Promise;return/native code/.test(_)&&(_.prototype.done=i,_.prototype.fail=o,_.defer||(_.defer=r)),window.Promise=_||h});